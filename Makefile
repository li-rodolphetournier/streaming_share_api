# Makefile pour Streaming App
# Commandes pour g√©rer Docker uniquement
# Compatible Windows PowerShell

.PHONY: help install start stop restart logs clean dev dev-all build test seed status apollo-dev apollo

# Variables
DOCKER_COMPOSE_FILE = streaming-app/docker-compose.yml
DOCKER_COMPOSE_DEV_FILE = streaming-app/docker-compose.dev.yml
BACKEND_DIR = streaming-app/backend
FRONTEND_DIR = streaming-app/frontend

# Commande par d√©faut
help: ## Afficher l'aide
	@echo "üé¨ Streaming App - Commandes Docker disponibles:"
	@echo ""
	@echo "üì¶ INSTALLATION:"
	@echo "  install          Installer toutes les d√©pendances"
	@echo "  build            Builder toutes les images Docker"
	@echo ""
	@echo "üöÄ D√âVELOPPEMENT:"
	@echo "  dev-all          Lancer TOUS les services Docker (PostgreSQL + Redis + Backend + Apollo + Frontend)"
	@echo "  dev              Lancer les services de base (PostgreSQL + Redis + Backend + Frontend)"
	@echo "  dev-db           Lancer seulement PostgreSQL et Redis"
	@echo "  dev-backend      Lancer PostgreSQL + Redis + Backend"
	@echo "  dev-apollo       Lancer PostgreSQL + Redis + Apollo GraphQL"
	@echo ""
	@echo "üè≠ PRODUCTION:"
	@echo "  prod             Lancer en mode production (avec Nginx)"
	@echo "  prod-build       Builder et lancer en mode production"
	@echo ""
	@echo "üóÑÔ∏è  BASE DE DONN√âES:"
	@echo "  seed             Peupler la base de donn√©es avec des donn√©es de test"
	@echo "  db-reset         R√©initialiser la base de donn√©es"
	@echo "  db-backup        Sauvegarder la base de donn√©es"
	@echo "  db-restore       Restaurer la base de donn√©es"
	@echo ""
	@echo "üìã MONITORING:"
	@echo "  logs             Voir les logs de tous les services"
	@echo "  logs-backend     Voir les logs du backend uniquement"
	@echo "  logs-apollo      Voir les logs d'Apollo GraphQL"
	@echo "  logs-frontend    Voir les logs du frontend"
	@echo "  logs-db          Voir les logs de PostgreSQL"
	@echo "  status           V√©rifier le statut de tous les services"
	@echo "  health           V√©rifier la sant√© des APIs"
	@echo ""
	@echo "üß™ TESTS:"
	@echo "  test             Lancer tous les tests"
	@echo "  test-backend     Lancer les tests du backend"
	@echo "  test-frontend    Lancer les tests du frontend"
	@echo ""
	@echo "üõë CONTR√îLE:"
	@echo "  stop             Arr√™ter tous les services"
	@echo "  restart          Red√©marrer tous les services"
	@echo "  restart-backend  Red√©marrer le backend uniquement"
	@echo "  restart-apollo   Red√©marrer Apollo GraphQL uniquement"
	@echo ""
	@echo "üßπ NETTOYAGE:"
	@echo "  clean            Nettoyer tous les conteneurs et volumes"
	@echo "  clean-images     Nettoyer les images Docker"
	@echo "  clean-all        Nettoyage complet (conteneurs + volumes + images)"
	@echo ""
	@echo "üîß UTILITAIRES:"
	@echo "  shell-backend    Ouvrir un shell dans le conteneur backend"
	@echo "  shell-apollo     Ouvrir un shell dans le conteneur Apollo"
	@echo "  shell-frontend   Ouvrir un shell dans le conteneur frontend"
	@echo "  shell-db         Ouvrir un shell PostgreSQL"
	@echo "  info             Afficher les informations du projet"
	@echo ""
	@echo "üìã Exemples d'utilisation:"
	@echo "  make install     # Installer et builder les images"
	@echo "  make dev-all     # Lancer TOUS les services (recommand√©)"
	@echo "  make logs        # Voir les logs en temps r√©el"
	@echo "  make stop        # Arr√™ter tous les services"

# Installation et build
install: ## Installer toutes les d√©pendances et builder les images
	@echo "üì¶ Installation et build des images Docker..."
	@$(MAKE) build
	@echo "‚úÖ Installation termin√©e!"

build: ## Builder toutes les images Docker
	@echo "üî® Build des images Docker..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml build --no-cache
	@echo "‚úÖ Build termin√©!"

# D√©veloppement avec Docker
dev-all: ## Lancer TOUS les services Docker (PostgreSQL + Redis + Backend + Apollo + Frontend)
	@echo "üöÄ D√©marrage COMPLET en mode d√©veloppement Docker..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml up -d
	@echo "‚è≥ Attente du d√©marrage des services..."
	@powershell -Command "Start-Sleep -Seconds 15"
	@$(MAKE) seed
	@echo "‚úÖ TOUS les services Docker sont d√©marr√©s!"
	@echo ""
	@echo "üåê URLs disponibles:"
	@echo "  Frontend:        http://localhost:3000"
	@echo "  Backend Express: http://localhost:3001"
	@echo "  Apollo GraphQL:  http://localhost:4000/graphql"
	@echo "  GraphQL Playground: http://localhost:4000/graphql"
	@echo "  PostgreSQL:      localhost:5432"
	@echo "  Redis:           localhost:6379"
	@echo ""
	@echo "üìã Commandes utiles:"
	@echo "  make logs        # Voir les logs"
	@echo "  make status      # V√©rifier le statut"
	@echo "  make stop        # Arr√™ter tous les services"

dev: ## Lancer les services de base (PostgreSQL + Redis + Backend + Frontend)
	@echo "üöÄ D√©marrage en mode d√©veloppement Docker..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml up -d postgres redis backend frontend
	@echo "‚è≥ Attente du d√©marrage des services..."
	@powershell -Command "Start-Sleep -Seconds 15"
	@$(MAKE) seed
	@echo "‚úÖ Services de d√©veloppement d√©marr√©s!"
	@echo "üåê Frontend: http://localhost:3000"
	@echo "üîß Backend: http://localhost:3001"

dev-db: ## Lancer seulement PostgreSQL et Redis
	@echo "üê≥ D√©marrage des services de base de donn√©es..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml up -d postgres redis
	@echo "‚úÖ Services de base de donn√©es d√©marr√©s!"

dev-backend: ## Lancer PostgreSQL + Redis + Backend
	@echo "üîß D√©marrage PostgreSQL + Redis + Backend..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml up -d postgres redis backend
	@echo "‚è≥ Attente du d√©marrage..."
	@powershell -Command "Start-Sleep -Seconds 10"
	@$(MAKE) seed
	@echo "‚úÖ Backend d√©marr√©!"

dev-apollo: ## Lancer PostgreSQL + Redis + Apollo GraphQL
	@echo "üöÄ D√©marrage PostgreSQL + Redis + Apollo GraphQL..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml up -d postgres redis apollo
	@echo "‚è≥ Attente du d√©marrage..."
	@powershell -Command "Start-Sleep -Seconds 10"
	@echo "‚úÖ Apollo GraphQL d√©marr√©!"
	@echo "üåê GraphQL Playground: http://localhost:4000/graphql"

# Production
prod: ## Lancer en mode production
	@echo "üè≠ D√©marrage en mode production..."
	cd streaming-app && docker-compose up -d
	@echo "‚úÖ Services de production d√©marr√©s!"
	@echo "üåê Application: http://localhost:8081"

prod-build: ## Builder et lancer en mode production
	@echo "üè≠ Build et d√©marrage en mode production..."
	cd streaming-app && docker-compose build --no-cache
	cd streaming-app && docker-compose up -d
	@echo "‚úÖ Services de production d√©marr√©s!"

# Base de donn√©es
seed: ## Peupler la base de donn√©es avec des donn√©es de test
	@echo "üå± Peuplement de la base de donn√©es..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec backend npm run seed
	@echo "‚úÖ Base de donn√©es peupl√©e!"

db-reset: ## R√©initialiser la base de donn√©es
	@echo "üóÑÔ∏è  R√©initialisation de la base de donn√©es..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec postgres psql -U streaming_user -d streaming_db -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
	@$(MAKE) seed
	@echo "‚úÖ Base de donn√©es r√©initialis√©e!"

db-backup: ## Sauvegarder la base de donn√©es
	@echo "üíæ Sauvegarde de la base de donn√©es..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec postgres pg_dump -U streaming_user streaming_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ Sauvegarde termin√©e!"

db-restore: ## Restaurer la base de donn√©es (sp√©cifier BACKUP_FILE=fichier.sql)
	@echo "üì• Restauration de la base de donn√©es..."
	@if [ -z "$(BACKUP_FILE)" ]; then echo "‚ùå Sp√©cifiez BACKUP_FILE=fichier.sql"; exit 1; fi
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec -T postgres psql -U streaming_user -d streaming_db < $(BACKUP_FILE)
	@echo "‚úÖ Restauration termin√©e!"

# Logs et monitoring
logs: ## Voir les logs de tous les services
	@echo "üìã Logs des services Docker:"
	cd streaming-app && docker-compose -f docker-compose.dev.yml logs -f

logs-backend: ## Voir les logs du backend uniquement
	@echo "üìã Logs du backend:"
	cd streaming-app && docker-compose -f docker-compose.dev.yml logs -f backend

logs-apollo: ## Voir les logs d'Apollo GraphQL
	@echo "üìã Logs d'Apollo GraphQL:"
	cd streaming-app && docker-compose -f docker-compose.dev.yml logs -f apollo

logs-frontend: ## Voir les logs du frontend
	@echo "üìã Logs du frontend:"
	cd streaming-app && docker-compose -f docker-compose.dev.yml logs -f frontend

logs-db: ## Voir les logs de PostgreSQL
	@echo "üìã Logs de PostgreSQL:"
	cd streaming-app && docker-compose -f docker-compose.dev.yml logs -f postgres

# Status et sant√©
status: ## V√©rifier le statut de tous les services
	@echo "üìä Statut des services Docker:"
	cd streaming-app && docker-compose -f docker-compose.dev.yml ps

health: ## V√©rifier la sant√© des APIs
	@echo "üè• V√©rification de la sant√© des APIs..."
	@echo "Backend Express:"
	@powershell -Command "try { Invoke-RestMethod -Uri 'http://localhost:3001/api/health' } catch { Write-Host '‚ùå Backend Express non accessible' }"
	@echo ""
	@echo "Apollo GraphQL:"
	@powershell -Command "try { Invoke-RestMethod -Uri 'http://localhost:4000/health' } catch { Write-Host '‚ùå Apollo GraphQL non accessible' }"

# Tests
test: ## Lancer tous les tests
	@echo "üß™ Lancement des tests..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec backend npm test
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec frontend npm test

test-backend: ## Lancer les tests du backend
	@echo "üß™ Tests backend..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec backend npm test

test-frontend: ## Lancer les tests du frontend
	@echo "üß™ Tests frontend..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec frontend npm test

# Contr√¥le des services
stop: ## Arr√™ter tous les services
	@echo "üõë Arr√™t de tous les services Docker..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml down
	cd streaming-app && docker-compose down
	@echo "‚úÖ Tous les services arr√™t√©s!"

restart: ## Red√©marrer tous les services
	@$(MAKE) stop
	@$(MAKE) dev-all

restart-backend: ## Red√©marrer le backend uniquement
	@echo "üîÑ Red√©marrage du backend..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml restart backend
	@echo "‚úÖ Backend red√©marr√©!"

restart-apollo: ## Red√©marrer Apollo GraphQL uniquement
	@echo "üîÑ Red√©marrage d'Apollo GraphQL..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml restart apollo
	@echo "‚úÖ Apollo GraphQL red√©marr√©!"

# Nettoyage
clean: ## Nettoyer tous les conteneurs et volumes
	@echo "üßπ Nettoyage des conteneurs et volumes..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml down -v
	cd streaming-app && docker-compose down -v
	docker container prune -f
	docker volume prune -f
	@echo "‚úÖ Nettoyage termin√©!"

clean-images: ## Nettoyer les images Docker
	@echo "üßπ Nettoyage des images Docker..."
	docker image prune -f
	docker rmi $(shell docker images -f "dangling=true" -q) 2>/dev/null || true
	@echo "‚úÖ Images nettoy√©es!"

clean-all: ## Nettoyage complet (conteneurs + volumes + images)
	@echo "üßπ Nettoyage complet..."
	@$(MAKE) clean
	@$(MAKE) clean-images
	docker system prune -f
	@echo "‚úÖ Nettoyage complet termin√©!"

# Utilitaires
shell-backend: ## Ouvrir un shell dans le conteneur backend
	@echo "üêö Shell backend..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec backend /bin/bash

shell-apollo: ## Ouvrir un shell dans le conteneur Apollo
	@echo "üêö Shell Apollo..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec apollo /bin/bash

shell-frontend: ## Ouvrir un shell dans le conteneur frontend
	@echo "üêö Shell frontend..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec frontend /bin/bash

shell-db: ## Ouvrir un shell PostgreSQL
	@echo "üêö Shell PostgreSQL..."
	cd streaming-app && docker-compose -f docker-compose.dev.yml exec postgres psql -U streaming_user -d streaming_db

# Informations
info: ## Afficher les informations du projet
	@echo "üìã Informations du projet:"
	@echo "Projet: Streaming App"
	@echo "Architecture: Microservices avec Docker"
	@echo "Backend: Node.js + TypeScript + TypeORM + PostgreSQL"
	@echo "GraphQL: Apollo Server + type-graphql"
	@echo "Frontend: React + Vite + TypeScript + TailwindCSS + Shadcn/ui"
	@echo "Base de donn√©es: PostgreSQL"
	@echo "Cache: Redis"
	@echo "Conteneurisation: Docker + Docker Compose"
	@echo ""
	@echo "üîó URLs de d√©veloppement:"
	@echo "Frontend:           http://localhost:3000"
	@echo "Backend Express:    http://localhost:3001"
	@echo "Apollo GraphQL:     http://localhost:4000/graphql"
	@echo "GraphQL Playground: http://localhost:4000/graphql"
	@echo "API Health:         http://localhost:3001/api/health"
	@echo "Apollo Health:      http://localhost:4000/health"
	@echo "PostgreSQL:         localhost:5432"
	@echo "Redis:              localhost:6379"
	@echo ""
	@echo "üîó URLs de production:"
	@echo "Application:        http://localhost:8081"
	@echo ""
	@echo "üë§ Comptes de test:"
	@echo "Admin: admin@streaming.com / admin123"
	@echo "User: user@streaming.com / user123" 